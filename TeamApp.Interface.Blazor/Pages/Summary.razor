@page "/summary"

@using TeamApp.Interface.Blazor.Pages.Standings
@using TeamApp.Interface.Blazor.Pages.Playoffs
@using TeamApp.Interface.Blazor.Pages.Games
@using TeamApp.Services
@using TeamApp.ViewModels.Views
@using TeamApp.ViewModels.Views.Games
@using TeamApp.ViewModels.Views.Competition.Playoff
@inject IGameDataService GameDataService
@inject ICompetitionService CompetitionService
@inject IStandingsService StandingsService
@inject IPlayoffService PlayoffService

    <div class="grid-container">
        <div class="mainmenu grid-menu">
            <NewMenu />
        </div>
        <br />

        <div class="grid-header">
            <h1>Daily View</h1>
            <b>Current Year </b>@summary.CurrentYear
            <br />
            <b>Current Day</b>@summary.CurrentDay
            <br />

            <h3>Actions</h3>
            <BSButton Value="PlayDay" OnClick="PlayDay" IsActive=@ShowPlayDay()>Play Day</BSButton>
            <BSButton Value="StartNextYear" OnClick="StartNextYear" IsActive=@ShowStartNextYear()>Start Next Year</BSButton>
            <BSButton Value="StartNextCompetition" OnClick="StartNextCompetition" IsActive=@ShowStartNextCompetition()>Start Next Competition</BSButton>
        </div>
        <div class="grid-scores">
            <ScheduleDaySummaryTabs @ref="DayTabs" FirstDay="@FirstDay" Year="@summary.CurrentYear" CurrentDay="@summary.CurrentDay" />          
        </div>
        <div class="grid-main">
            <BSTabGroup>
                <BSTabList IsPills="true" IsList="true">
                    <BSTab>
                        <BSTabLabel>Standings</BSTabLabel>
                        <BSTabContent>
                            <Standings model=@standings />
                        </BSTabContent>
                    </BSTab>
                    <BSTab>
                        <BSTabLabel>Playoffs</BSTabLabel>
                        <BSTabContent>
                            <Playoffs model=@playoffs />
                        </BSTabContent>
                    </BSTab>
                </BSTabList>
                <BSTabSelectedContent />
            </BSTabGroup>
        </div>
    </div>
@code {
        GameSummary summary;
        StandingsViewModel standings;
        ScheduleDaySummaryViewModel[] days;
        PlayoffSummaryViewModel playoffs;
        ScheduleDaySummaryTabs DayTabs;

        int FirstDay { get; set; }


    protected override async Task OnInitializedAsync()
    {
        await RefreshData();

    }

    private async Task RefreshData()
    {
        summary = await GameDataService.GetGameSummary();
        FirstDay = summary.CurrentDay - 1;
        standings = await StandingsService.GetStandings(1, summary.CurrentYear, 1);
        playoffs = await PlayoffService.GetPlayoffSummary(2, summary.CurrentYear);

        if (DayTabs != null)
        {
            await DayTabs.FirstDayChanged(FirstDay);
        }

        StateHasChanged();

    }

    protected bool ShowPlayDay()
    {
        return summary.AllowPlayGames;
    }

    protected bool ShowStartNextYear()
    {
        return summary.AllowIncrementYear;
    }

    protected bool ShowStartNextCompetition()
    {
        return summary.AllowStartNextCompetition;
    }

    async void PlayDay(MouseEventArgs args)
    {
        GameDataService.PlayAndProcessDay();
        await RefreshData();
    }

    async public void StartNextCompetition(MouseEventArgs args)
    {
        GameDataService.StartNextCompetition();
        await RefreshData();
    }

    async public void StartNextYear(MouseEventArgs args)
    {
        GameDataService.StartNextYear();
        await RefreshData();
    }


}
